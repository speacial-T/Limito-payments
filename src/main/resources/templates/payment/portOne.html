<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <link rel="icon" type="image/png" th:href="@{/favicon.png}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/portOne.css}"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>í¬íŠ¸ì› ê²°ì œì—°ë™ ìƒ˜í”Œ</title>
    <script src="https://cdn.portone.io/v2/browser-sdk.js" async defer></script>
</head>
<body>
<div id="root">
    <dialog id="loadingDialog" open>
        <article aria-busy="true">ê²°ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.</article>
    </dialog>
    <main id="checkoutDialog" style="display: none">
        <form id="checkoutForm">
            <article>
                <div class="item">
                    <h3 id="itemSummaryHeader"></h3>
                    <ul id="itemList">
                    </ul>
                </div>
                <div class="price">
                    <label>ì´ êµ¬ì… ê°€ê²©</label>
                    <span id="totalPriceValue" class="price-value"></span>
                </div>
            </article>
            <button id="checkoutButton" type="submit">ê²°ì œ</button>
        </form>
    </main>
    <dialog id="failDialog">
        <header>
            <h1>ê²°ì œ ì‹¤íŒ¨</h1>
        </header>
        <p id="failMessage"></p>
        <button type="button" class="closeDialog">ë‹«ê¸°</button>
    </dialog>
    <dialog id="successDialog">
        <header>
            <h1>ê²°ì œ ì„±ê³µ</h1>
        </header>
        <p>ê²°ì œì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.</p>
        <button type="button" class="closeDialog">ë‹«ê¸°</button>
    </dialog>
    <dialog id="virtualAccountDialog">
        <header>
            <h1>ê°€ìƒê³„ì¢Œ ë°œê¸‰ ì™„ë£Œ</h1>
        </header>
        <p>ê°€ìƒê³„ì¢Œê°€ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        <button type="button" class="closeDialog">ë‹«ê¸°</button>
    </dialog>
</div>
<!--<script src="/config.js"></script>-->
<script th:inline="javascript">
    const orderId = '[[${orderId}]]';
    const itemSummary = '[[${itemSummary}]]';
    const itemsString = '[[${items}]]'; // JSON ë¬¸ìì—´ë¡œ ë°›ìŒ
    // ğŸš¨ ìˆ˜ì •: JSON ë¬¸ìì—´ì„ ì‹¤ì œ ë°°ì—´ ê°ì²´ë¡œ íŒŒì‹±
    const items = JSON.parse(itemsString);
    const totalPrice = '[[${totalPrice}]]';
    const storeId = '[[${storeId}]]';
    const channelKey = '[[${channelKey}]]';
    console.log("channelKey :", channelKey);
    console.log("storeId :", storeId);
    const checkout = new Checkout(
        storeId, // ìƒì  ID
        channelKey, // ì±„ë„ í‚¤
    )
    checkout.load()

    function Checkout(storeId, channelKey) {
        // ëª©ì—… ë°ì´í„° ëŒ€ì‹  ì„œë²„ì—ì„œ ì „ë‹¬ëœ ë°ì´í„° ì‚¬ìš©
        const orderData = {
            orderId: orderId,
            itemSummary: itemSummary,
            items: items, // íŒŒì‹±ëœ ë°°ì—´ ì‚¬ìš©
            totalPrice: totalPrice,
        };

        this.load = async () => {
            const waitPortOne = new Promise((resolve) => {
                const polling = setInterval(() => {
                    if (window.PortOne != null) {
                        clearInterval(polling)
                        resolve()
                    }
                }, 50)
            })

            // ëª©ì—… ë°ì´í„° ë¡œë”© ëŒ€ê¸° ì½”ë“œë¥¼ ì œê±°í•˜ê³  PortOne ë¡œë”©ë§Œ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
            await Promise.all([waitPortOne])

            window.loadingDialog.open = false
            window.checkoutDialog.open = true
            await this.showCheckout()
        }

        this.showCheckout = async () => {
            document.getElementById('itemSummaryHeader').replaceChildren(orderData.itemSummary);

            // ìƒí’ˆ ì´ ê°€ê²© í‘œì‹œ
            document.getElementById('totalPriceValue').replaceChildren(`${orderData.totalPrice.toLocaleString()}ì›`);

            const itemListElement = document.getElementById('itemList');
            itemListElement.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

            // ìƒí’ˆ ëª©ë¡ì„ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ì—¬ í‘œì‹œ
            orderData.items.forEach(item => {
                const li = document.createElement('li');
                const amountText = item.productPrice != null ? `${item.productPrice.toLocaleString()}ì›` : 'ê°€ê²© ì •ë³´ ì—†ìŒ';
                li.innerHTML = `
                    <div class="item-text">
                        <h5>${item.productName}</h5>
                        <p class="price-value">${amountText}</p>
                    </div>
                    <p>${item.quantity} ê°œ</p>
                `;
                itemListElement.appendChild(li);
            });

            window.checkoutDialog.onsubmit = async (e) => {
                e.preventDefault()
                this.setWaitingPayment(true)
                const paymentId = randomId()

                // PortOne ê²°ì œ ìš”ì²­
                const payment = await PortOne.requestPayment({
                    storeId,
                    channelKey,
                    paymentId,
                    orderName: orderData.itemSummary, // ìƒí’ˆ ìš”ì•½ ì‚¬ìš©
                    totalAmount: orderData.totalPrice, // ì´ ê°€ê²© ì‚¬ìš©
                    currency: "KRW",
                    payMethod: "CARD",
                    customData: {
                        orderId: orderData.orderId, // ì£¼ë¬¸ IDë¥¼ customDataì— í¬í•¨
                    },
                })

                if (payment.code != null) {
                    this.setWaitingPayment(false)
                    console.log(payment)
                    this.openFailDialog(payment.message)
                    return
                }

                // ê²°ì œ ìŠ¹ì¸ ìš”ì²­ (Controllerì˜ @PostMapping("/v1/payments/{orderId}/confirm") ê²½ë¡œë¡œ ë³€ê²½)
                const completeResponse = await fetch(`/v1/payments/${orderData.orderId}/confirm`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        orderId: payment.orderId,
                        paymentId: payment.paymentId,
                        amount: payment.totalAmount,
                        confirmedAt: payment.confirmedAt
                    }),
                })

                this.setWaitingPayment(false)

                if (completeResponse.ok) {
                    const paymentComplete = await completeResponse.json()
                    switch (paymentComplete.status) {
                        case "PAID":
                            this.openSuccessDialog()
                            break
                        case "VIRTUAL_ACCOUNT_ISSUED":
                            this.openVirtualAccountDialog()
                            break
                    }
                } else {
                    this.openFailDialog(await completeResponse.text())
                }
            }

            for (const dialogButton of document.getElementsByClassName(
                "closeDialog",
            )) {
                dialogButton.onclick = () => {
                    dialogButton.closest('dialog').open = false
                }
            }
            window.checkoutDialog.style = ""
        }

        this.setWaitingPayment = (isWaiting) => {
            window.checkoutButton.setAttribute("aria-busy", isWaiting.toString())
            window.checkoutButton.disabled = isWaiting
        }
        this.openFailDialog = (message) => {
            window.failMessage.replaceChildren(message)
            window.failDialog.open = true
        }
        this.openSuccessDialog = () => {
            window.successDialog.open = true
        }
        this.openVirtualAccountDialog = () => {
            window.virtualAccountDialog.open = true
        }

        function randomId() {
            return [...crypto.getRandomValues(new Uint32Array(2))]
                .map((word) => word.toString(16).padStart(8, "0"))
                .join("")
        }
    }
</script>
</body>
</html>